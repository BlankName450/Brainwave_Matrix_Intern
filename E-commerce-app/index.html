<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Trendora - Discover Your Style</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="mainContent">
    
    <!-- Site Header: Logo, Search, User Actions -->
    <header class="header">
        <div class="header-content">
            <div class="logo">Trendora</div>
            <div class="search-bar">
                <input type="text" placeholder="What are you looking for?" id="searchInput" autocomplete="off">
                <div id="searchSuggestions" class="search-suggestions" style="display:none;"></div>
            </div>
            <div class="header-actions">
                <button id="themeToggleBtn" title="Toggle dark/light mode" style="background:none;border:none;cursor:pointer;font-size:1.3rem;display:flex;align-items:center;gap:4px;">
                  <span id="themeIcon">🌙</span>
                </button>
                <div class="cart-icon" id="cartIcon">
                    🛒
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <span id="userDisplayName">Guest</span>
                <button id="logoutBtn" style="margin-left:12px;padding:6px 14px;border-radius:6px;border:none;background:#eee;color:#333;font-weight:500;cursor:pointer;">Log out</button>
                <button id="wishlistBtn" title="View Wishlist" style="background:none;border:none;cursor:pointer;font-size:1.3rem;display:flex;align-items:center;gap:4px;">
                  <span id="wishlistIcon">♡</span>
                </button>
                <button id="adminPanelBtn" style="display:none;background:none;border:none;cursor:pointer;font-size:1.1rem;padding:6px 14px;border-radius:6px;font-weight:500;">Admin Panel</button>
            </div>
        </div>
    </header>

    <!-- Hero Section with Floating Category Icons -->
    <section class="hero">
        <h1>Unbox Everything You Love</h1>
        <p>Tech, Fashion, Beauty, and More — Curated Just for You.</p>
        <br>
        <p>Shop the Trends. Love the Prices. Shop Trendora.</p>
        <div class="hero-floating-icons">
          <!-- SVG icons for product categories, animated with JS -->
          <svg class="floating-icon" data-float title="Shoe" style="left:10%;top:60%;width:48px;height:48px;" viewBox="0 0 48 48" fill="none"><path d="M6 36c0-2 1-4 3-5l13-7 7-13c1-2 3-3 5-3h2c2 0 4 2 4 4v2c0 2-1 4-3 5l-13 7-7 13c-1 2-3 3-5 3h-2c-2 0-4-2-4-4v-2z" fill="white" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Dress" style="left:30%;top:70%;width:40px;height:40px;" viewBox="0 0 48 48" fill="none"><path d="M24 6c2 0 4 2 4 4v4l6 10h-4l-2 10h-8l-2-10h-4l6-10v-4c0-2 2-4 4-4z" fill="white" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Phone" style="left:60%;top:65%;width:36px;height:36px;" viewBox="0 0 48 48" fill="none"><rect x="14" y="6" width="20" height="36" rx="4" fill="white" fill-opacity="0.7"/><rect x="20" y="38" width="8" height="2" rx="1" fill="#bbb" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Bag" style="left:80%;top:75%;width:52px;height:52px;" viewBox="0 0 48 48" fill="none"><rect x="10" y="18" width="28" height="18" rx="4" fill="white" fill-opacity="0.7"/><path d="M16 18v-4a8 8 0 0 1 16 0v4" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
          <svg class="floating-icon" data-float title="Lipstick" style="left:20%;top:80%;width:32px;height:32px;" viewBox="0 0 48 48" fill="none"><rect x="20" y="28" width="8" height="12" rx="2" fill="white" fill-opacity="0.7"/><rect x="22" y="12" width="4" height="16" rx="2" fill="#fff" fill-opacity="0.7"/><rect x="22" y="8" width="4" height="6" rx="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Watch" style="left:50%;top:75%;width:44px;height:44px;" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="10" fill="white" fill-opacity="0.7"/><rect x="22" y="6" width="4" height="8" rx="2" fill="#fff" fill-opacity="0.7"/><rect x="22" y="34" width="4" height="8" rx="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Sunglasses" style="left:15%;top:30%;width:38px;height:38px;" viewBox="0 0 48 48" fill="none"><ellipse cx="16" cy="28" rx="8" ry="6" fill="white" fill-opacity="0.7"/><ellipse cx="32" cy="28" rx="8" ry="6" fill="white" fill-opacity="0.7"/><rect x="8" y="27" width="32" height="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Headphones" style="left:40%;top:10%;width:50px;height:50px;" viewBox="0 0 48 48" fill="none"><path d="M8 28a16 16 0 0 1 32 0v8a4 4 0 0 1-8 0v-6a4 4 0 0 0-8 0v6a4 4 0 0 1-8 0v-8z" fill="white" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Perfume" style="left:70%;top:20%;width:36px;height:36px;" viewBox="0 0 48 48" fill="none"><rect x="16" y="20" width="16" height="18" rx="4" fill="white" fill-opacity="0.7"/><rect x="20" y="10" width="8" height="8" rx="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="T-shirt" style="left:35%;top:40%;width:42px;height:42px;" viewBox="0 0 48 48" fill="none"><path d="M12 10l12-6 12 6-4 6h-16l-4-6z" fill="white" fill-opacity="0.7"/><rect x="16" y="16" width="16" height="22" rx="4" fill="white" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Laptop" style="left:55%;top:15%;width:48px;height:48px;" viewBox="0 0 48 48" fill="none"><rect x="10" y="14" width="28" height="16" rx="3" fill="white" fill-opacity="0.7"/><rect x="6" y="32" width="36" height="4" rx="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Ring" style="left:75%;top:35%;width:36px;height:36px;" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="28" r="10" stroke="white" stroke-width="4" fill="none" opacity="0.7"/><rect x="20" y="10" width="8" height="6" rx="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Shoe" style="left:60%;top:30%;width:32px;height:32px;" viewBox="0 0 48 48" fill="none"><path d="M6 36c0-2 1-4 3-5l13-7 7-13c1-2 3-3 5-3h2c2 0 4 2 4 4v2c0 2-1 4-3 5l-13 7-7 13c-1 2-3 3-5 3h-2c-2 0-4-2-4-4v-2z" fill="white" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Dress" style="left:10%;top:10%;width:28px;height:28px;" viewBox="0 0 48 48" fill="none"><path d="M24 6c2 0 4 2 4 4v4l6 10h-4l-2 10h-8l-2-10h-4l6-10v-4c0-2 2-4 4-4z" fill="white" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Phone" style="left:80%;top:10%;width:24px;height:24px;" viewBox="0 0 48 48" fill="none"><rect x="14" y="6" width="20" height="36" rx="4" fill="white" fill-opacity="0.7"/><rect x="20" y="38" width="8" height="2" rx="1" fill="#bbb" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Bag" style="left:5%;top:20%;width:72px;height:72px;" viewBox="0 0 48 48" fill="none"><rect x="10" y="18" width="28" height="18" rx="4" fill="white" fill-opacity="0.7"/><path d="M16 18v-4a8 8 0 0 1 16 0v4" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
          <svg class="floating-icon" data-float title="Watch" style="left:85%;top:50%;width:96px;height:96px;" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="10" fill="white" fill-opacity="0.7"/><rect x="22" y="6" width="4" height="8" rx="2" fill="#fff" fill-opacity="0.7"/><rect x="22" y="34" width="4" height="8" rx="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Sunglasses" style="left:45%;top:5%;width:80px;height:80px;" viewBox="0 0 48 48" fill="none"><ellipse cx="16" cy="28" rx="8" ry="6" fill="white" fill-opacity="0.7"/><ellipse cx="32" cy="28" rx="8" ry="6" fill="white" fill-opacity="0.7"/><rect x="8" y="27" width="32" height="2" fill="#fff" fill-opacity="0.7"/></svg>
          <svg class="floating-icon" data-float title="Laptop" style="left:70%;top:60%;width:120px;height:120px;" viewBox="0 0 48 48" fill="none"><rect x="10" y="14" width="28" height="16" rx="3" fill="white" fill-opacity="0.7"/><rect x="6" y="32" width="36" height="4" rx="2" fill="#fff" fill-opacity="0.7"/></svg>
        </div>
    </section>

    <!-- Main Content: Sidebar Filters and Product Grid -->
    <main class="main-content">
        <div class="filter-overlay" id="filterOverlay"></div>
        <aside class="sidebar" id="sidebar">
            <button class="close-filter" id="closeFilterBtn">&times;</button>
            <div class="filter-section">
                <h3>Sort by</h3>
                <select id="sortBy">
                    <option value="popular">Popular</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="rating">Best Rating</option>
                </select>
            </div>
            <div class="filter-section">
                <h3>Categories</h3>
                <div id="categoryFilters">
                    <!-- Categories will be rendered here dynamically -->
                </div>
            </div>
            <div class="filter-section">
                <h3>Price Range</h3>
                <div class="price-range">
                    <input type="number" id="minPrice" placeholder="Min" min="0">
                    <span>-</span>
                    <input type="number" id="maxPrice" placeholder="Max" min="0">
                </div>
            </div>
            <div class="filter-section">
                <h3>Rating</h3>
                <div class="filter-option">
                    <input type="checkbox" id="rating4plus" value="4">
                    <label for="rating4plus">4★ & above</label>
                </div>
                <div class="filter-option">
                    <input type="checkbox" id="rating3plus" value="3">
                    <label for="rating3plus">3★ & above</label>
                </div>
            </div>
        </aside>
        <section class="products-section">
            <div class="products-header">
                <div class="results-count" id="resultsCount">Loading products...</div>
                <div class="view-toggle" id="viewToggleContainer">
                    <button class="view-btn active" id="gridView">⚏</button>
                    <button class="view-btn" id="listView">☰</button>
                </div>
                <button class="filter-modal-btn" id="filterModalBtn">🔍 Filter & Sort</button>
            </div>
            <div class="products-grid" id="productsGrid">
                <div class="spinner" id="productsSpinner"></div>
            </div>
            <button id="loadMoreBtn" style="display:none;margin:20px auto 0;display:block;padding:12px 32px;background:#4ecdc4;color:#fff;border:none;border-radius:4px;font-size:16px;cursor:pointer;">Load More</button>
        </section>
    </main>
    <script>
        // Global variables
        let allProducts = [];
        let filteredProducts = [];
        let categories = [];
        let cart = [];
        let productsToShow = 30;
        let currentIndex = 0;
        let mixedProducts = [];

        // DOM elements
        const productsGrid = document.getElementById('productsGrid');
        const resultsCount = document.getElementById('resultsCount');
        const categoryFilters = document.getElementById('categoryFilters');
        const searchInput = document.getElementById('searchInput');
        const sortBy = document.getElementById('sortBy');
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        const cartCount = document.getElementById('cartCount');
        const sidebar = document.getElementById('sidebar');
        const filterOverlay = document.getElementById('filterOverlay');
        const closeFilterBtn = document.getElementById('closeFilterBtn');
        const filterModalBtn = document.getElementById('filterModalBtn');

        // Initialize app
        async function init() {
            document.getElementById('productsSpinner').style.display = 'flex';
            productsGrid.innerHTML = '';
            try {
                await loadProducts();
                await loadCategories();
                setupEventListeners();
                applyFilters();
            } catch (error) {
                productsGrid.innerHTML = '<div class="no-products">Error loading products. Please try again later.</div>';
            }
        }

        // Load products from API
        async function fetchAllProductsForCategory(category) {
            let products = [];
            let limit = 30;
            let skip = 0;
            let total = 0;
            do {
                const response = await fetch(`https://dummyjson.com/products/category/${category}?limit=${limit}&skip=${skip}`);
                const data = await response.json();
                products = products.concat(data.products);
                total = data.total;
                skip += limit;
            } while (products.length < total);
            return products;
        }

        // --- PRODUCT LOADING LOGIC WITH ADMIN PRODUCTS PERSISTENCE ---
        async function loadProducts() {
            // If adminProducts exist in localStorage, use them and skip API fetch
            if (localStorage.getItem('adminProducts')) {
                try {
                    allProducts = JSON.parse(localStorage.getItem('adminProducts'));
                    filteredProducts = [...allProducts];
                    return;
                } catch {}
            }
            // Otherwise, fetch from API as before
            try {
                const allowedCategories = [
                    'mens-shirts', 'womens-dresses', 'womens-shoes', 'mens-shoes', 'tops', 'womens-bags', 'womens-jewellery', 'sunglasses',
                    'smartphones', 'laptops', 'tablets', 'mobile-accessories', 'headphones',
                    'fragrances', 'skincare', 'makeup', 'beauty'
                ];
                let fetchedProducts = [];
                for (const category of allowedCategories) {
                    try {
                        const products = await fetchAllProductsForCategory(category);
                        fetchedProducts = [...fetchedProducts, ...products];
                    } catch (error) {
                        // skip missing categories
                    }
                }
                // Shuffle for variety
                mixedProducts = fetchedProducts.sort(() => Math.random() - 0.5);
                allProducts = mixedProducts;
                filteredProducts = [...allProducts];
            } catch (error) {
                throw new Error('Failed to load products');
            }
        }

        // Load all categories
        async function loadCategories() {
            try {
                // Extract unique categories from loaded products
                categories = [...new Set(allProducts.map(product => product.category))];
                renderCategoryFilters();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Render category filters
        function renderCategoryFilters() {
            categoryFilters.innerHTML = categories.map(category => `
                <div class="filter-option">
                    <input type="checkbox" id="category-${category}" value="${category}" class="category-filter">
                    <label for="category-${category}">${formatCategoryName(category)}</label>
                </div>
            `).join('');
        }

        // Format category name for display
        function formatCategoryName(category) {
            return category.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search
            searchInput.addEventListener('input', debounce(applyFilters, 300));
            
            // Sort
            sortBy.addEventListener('change', applyFilters);
            
            // Price range
            minPrice.addEventListener('input', debounce(applyFilters, 300));
            maxPrice.addEventListener('input', debounce(applyFilters, 300));
            
            // Category filters
            categoryFilters.addEventListener('change', applyFilters);
            
            // Rating filters
            document.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox' && (e.target.id.includes('rating') || e.target.classList.contains('category-filter'))) {
                    applyFilters();
                }
            });

            // Mobile filter toggle
            filterModalBtn.addEventListener('click', openSidebar);

            // View toggle
            const gridViewBtn = document.getElementById('gridView');
            const listViewBtn = document.getElementById('listView');
            const viewToggleContainer = document.getElementById('viewToggleContainer');
            function isMobile() {
                return window.innerWidth <= 600;
            }
            function setViewModeOnResize() {
                if (isMobile()) {
                    productsGrid.classList.remove('list-view');
                    gridViewBtn.classList.add('active');
                    listViewBtn.classList.remove('active');
                    if (viewToggleContainer) viewToggleContainer.style.display = 'none';
                } else {
                    if (viewToggleContainer) viewToggleContainer.style.display = '';
                }
            }
            gridViewBtn.addEventListener('click', () => {
                if (isMobile()) return;
                gridViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                productsGrid.classList.remove('list-view');
            });
            listViewBtn.addEventListener('click', () => {
                if (isMobile()) return;
                listViewBtn.classList.add('active');
                gridViewBtn.classList.remove('active');
                productsGrid.classList.add('list-view');
            });
            window.addEventListener('resize', setViewModeOnResize);
            setViewModeOnResize();

            // Load More button
            document.getElementById('loadMoreBtn').addEventListener('click', () => {
                currentIndex += productsToShow;
                renderProducts();
            });
        }

        // Apply filters
        function applyFilters() {
            let filtered = [...allProducts];

            // Search filter
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(product => 
                    product.title.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm)
                );
            }

            // Category filter
            const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(cb => cb.value);
            if (selectedCategories.length > 0) {
                filtered = filtered.filter(product => selectedCategories.includes(product.category));
            }

            // Price range filter
            const minPriceValue = parseFloat(minPrice.value) || 0;
            const maxPriceValue = parseFloat(maxPrice.value) || Infinity;
            filtered = filtered.filter(product => product.price >= minPriceValue && product.price <= maxPriceValue);

            // Rating filter
            const rating4Plus = document.getElementById('rating4plus')?.checked;
            const rating3Plus = document.getElementById('rating3plus')?.checked;
            if (rating4Plus) {
                filtered = filtered.filter(product => product.rating >= 4);
            } else if (rating3Plus) {
                filtered = filtered.filter(product => product.rating >= 3);
            }

            // Sort products
            const sortValue = sortBy.value;
            switch (sortValue) {
                case 'price-low':
                    filtered.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high':
                    filtered.sort((a, b) => b.price - a.price);
                    break;
                case 'rating':
                    filtered.sort((a, b) => b.rating - a.rating);
                    break;
                default:
                    // Popular - keep original order
                    break;
            }

            filteredProducts = filtered;
            currentIndex = 0;
            renderProducts();
        }

        // Render products
        function renderProducts() {
            const spinner = document.getElementById('productsSpinner');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = '<div class="no-products">No products found matching your criteria.</div>';
                if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                return;
            }
            if (spinner) spinner.style.display = 'none';
            let end = Math.min(currentIndex + productsToShow, filteredProducts.length);
            let productsToRender = filteredProducts.slice(0, end);
            productsGrid.innerHTML = productsToRender.map(product => {
                let badgesArr = [];
                if (product.stock < 5) badgesArr.push(`<span class='product-badge'>Low Stock</span>`);
                if (product.rating >= 4.5) badgesArr.push(`<span class='product-badge best-seller'>Best Seller</span>`);
                if (product.discountPercentage && product.discountPercentage > 0) badgesArr.push(`<span class='product-badge sale'>Sale</span>`);
                let badges = badgesArr.length ? `<div class='product-badges-stack'>${badgesArr.join('')}</div>` : '';
                return `
                <div class="product-card fade-in" data-product-id="${product.id}" style="position:relative;">
                    ${badges}
                    <img src="${product.thumbnail}" alt="${product.title}" class="product-image" loading="lazy">
                    <div class="product-info">
                        <h3 class="product-title">${product.title}</h3>
                        <div class="product-price">$<span>${product.price.toFixed(2)}</span></div>
                        <div class="product-rating">
                            <span class="stars">${generateStars(product.rating)}</span>
                            <span class="rating-count">(${product.stock} in stock)</span>
                        </div>
                        <button class="add-to-cart" onclick="addToCart(${product.id})">Add to Cart</button>
                    </div>
                </div>
                `;
            }).join('');
            if (end < filteredProducts.length) {
                if (loadMoreBtn) loadMoreBtn.style.display = 'block';
            } else {
                if (loadMoreBtn) loadMoreBtn.style.display = 'none';
            }
            updateResultsCount(end);
            makeProductCardsInteractive();
        }

        // Generate stars for rating
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            return '★'.repeat(fullStars) + (halfStar ? '☆' : '') + '☆'.repeat(emptyStars);
        }

        // Update results count
        function updateResultsCount(currentlyShowing) {
            if (typeof currentlyShowing === 'undefined') currentlyShowing = Math.min(currentIndex + productsToShow, filteredProducts.length);
            resultsCount.textContent = `${currentlyShowing} of ${filteredProducts.length} result${filteredProducts.length !== 1 ? 's' : ''} for products`;
        }

        // --- FLY-TO-ICON ANIMATION FUNCTION ---
        function animateFlyToIcon(productImg, iconSelector) {
          const icon = document.querySelector(iconSelector);
          if (!productImg || !icon) return;
          
          const imgRect = productImg.getBoundingClientRect();
          const iconRect = icon.getBoundingClientRect();
          // Create a clone of the product image
          const flyingImg = productImg.cloneNode(true);
          flyingImg.style.position = 'fixed';
          flyingImg.style.left = imgRect.left + 'px';
          flyingImg.style.top = imgRect.top + 'px';
          flyingImg.style.width = imgRect.width + 'px';
          flyingImg.style.height = imgRect.height + 'px';
          flyingImg.style.transition = 'all 0.8s cubic-bezier(.4,2,.6,1)';
          flyingImg.style.zIndex = 9999;
          flyingImg.style.pointerEvents = 'none';
          flyingImg.style.borderRadius = '12px';
          document.body.appendChild(flyingImg);
          // Force reflow for transition
          flyingImg.getBoundingClientRect();
          // Animate to icon
          flyingImg.style.left = (iconRect.left + iconRect.width/2 - imgRect.width/4) + 'px';
          flyingImg.style.top = (iconRect.top + iconRect.height/2 - imgRect.height/4) + 'px';
          flyingImg.style.width = imgRect.width/2 + 'px';
          flyingImg.style.height = imgRect.height/2 + 'px';
          flyingImg.style.opacity = '0.5';
          // Remove after animation
          setTimeout(() => {
            flyingImg.remove();
          }, 800);
        }

        // Add to cart
        async function addToCart(productId) {
            // Fetch product info to get stock
            let product = allProducts.find(p => p.id === productId);
            if (!product) {
                // fallback to API if not found
                try {
                    const res = await fetch(`https://dummyjson.com/products/${productId}`);
                    product = await res.json();
                } catch { product = null; }
            }
            if (!product) return;
            const cartItem = cart.find(item => item.id === productId);
            const inCartQty = cartItem ? cartItem.quantity : 0;
            if (product.stock === 0) {
                showAlertModal('Sorry, this product is out of stock.');
                return;
            }
            if (inCartQty >= product.stock) {
                showAlertModal('You cannot add more than the available stock for this product.');
                return;
            }
            if (cartItem) {
                cartItem.quantity += 1;
            } else {
                cart.push({ id: productId, quantity: 1 });
            }
            updateCartCount();
            saveCartToStorage();
            // --- FLY TO CART ANIMATION ---
            if (event && event.target) {
                const card = event.target.closest('.product-card');
                if (card) {
                    const img = card.querySelector('.product-image');
                    animateFlyToIcon(img, '#cartIcon');
                }
            }
            // Show feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Added!';
            button.style.background = '#45b7aa';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#4ecdc4';
            }, 1000);
        }

        // Update cart count
        function updateCartCount() {
            const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalQty;
            saveCartToStorage();
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Mobile filter overlay logic
        function openSidebar() {
            // Prevent opening if any modal is open
            if (
                document.body.classList.contains('modal-blur') ||
                document.body.classList.contains('modal-blur-product') ||
                document.getElementById('loginModalOverlay').classList.contains('active') ||
                document.getElementById('cartModalOverlay').classList.contains('active') ||
                document.getElementById('productModalOverlay').classList.contains('active') ||
                document.getElementById('paymentModalOverlay').classList.contains('active') ||
                document.getElementById('alertModalOverlay').classList.contains('active')
            ) {
                return;
            }
            sidebar.classList.add('active');
            filterOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeSidebar() {
            sidebar.classList.remove('active');
            filterOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        closeFilterBtn.addEventListener('click', closeSidebar);
        filterOverlay.addEventListener('click', closeSidebar);
        // Prevent closing when clicking inside sidebar
        sidebar.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
    </div>
    <!-- Login Modal Overlay for User Authentication -->
    <div id="loginModalOverlay">
      <div id="loginModalContent"></div>
    </div>
    <script>
    // --- LOAD CURRENT USER FROM LOCALSTORAGE AT THE VERY TOP ---
    let currentUser = null;
    function loadCurrentUserFromStorage() {
      const stored = localStorage.getItem('currentUser');
      if (stored) {
        try {
          currentUser = JSON.parse(stored);
        } catch {
          currentUser = null;
        }
      } else {
        currentUser = null;
      }
    }
    loadCurrentUserFromStorage();
    // Login modal loader and blur logic
    function showLoginModalIfNeeded() {
      // Only show login modal if there is NO currentUser object (not just localStorage)
      if (!currentUser) {
        fetch('login-card.html')
          .then(response => response.text())
          .then(html => {
            document.getElementById('loginModalContent').innerHTML = html;
            document.getElementById('loginModalOverlay').classList.add('active');
            document.body.classList.add('modal-blur');
          });
      } else {
        // If user is present, set hasVisited so modal doesn't show again
        localStorage.setItem('hasVisited', 'true');
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      showLoginModalIfNeeded();
    });
    window.closeLoginModal = function() {
      document.getElementById('loginModalOverlay').classList.remove('active');
      document.body.classList.remove('modal-blur');
      // Update username display after login/signup/guest/admin
      if (currentUser && currentUser.name) {
        document.getElementById('userDisplayName').textContent = currentUser.name;
      } else {
        document.getElementById('userDisplayName').textContent = 'Guest';
      }
      // Set hasVisited so login modal doesn't show again
      localStorage.setItem('hasVisited', 'true');
    }
    </script>
    <script>
    // Login card logic from login-card.html
    let users = [
        { id: 1, name: 'Demo User', email: 'demo@trendora.com', password: 'password123', phone: '+1234567890' },
        { id: 2, name: 'John Doe', email: 'john@example.com', password: 'john123', phone: '+1987654321' }
    ];
    const adminCredentials = {
        email: 'admin@trendora.com',
        password: 'admin123',
        code: 'TRENDORA2024'
    };
    let isGuest = false;
    window.showWelcome = function() {
        hideAllScreens();
        document.getElementById('welcomeScreen').classList.add('active');
    }
    window.showLogin = function() {
        hideAllScreens();
        document.getElementById('loginForm').classList.add('active');
        showUserLogin();
    }
    window.showSignup = function() {
        hideAllScreens();
        document.getElementById('signupForm').classList.add('active');
    }
    window.showUserLogin = function() {
        document.getElementById('adminForm').classList.remove('active');
        document.getElementById('loginForm').classList.add('active');
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.toggle-btn')[0].classList.add('active');
    }
    window.showAdminLogin = function() {
        document.getElementById('loginForm').classList.remove('active');
        document.getElementById('adminForm').classList.add('active');
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.toggle-btn')[1].classList.add('active');
    }
    function hideAllScreens() {
        document.querySelectorAll('.welcome-screen, .form-container').forEach(screen => {
            screen.classList.remove('active');
        });
    }
    window.handleLogin = function(event) {
        event.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        showLoading('loginLoading');
        hideMessage('loginError');
        hideMessage('loginSuccess');
        setTimeout(() => {
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                saveCurrentUserToStorage();
                showMessage('loginSuccess', 'Login successful! Redirecting...');
                setTimeout(() => {
                    window.closeLoginModal();
                }, 1200);
            } else {
                showMessage('loginError', 'Invalid email or password. Please try again.');
            }
            hideLoading('loginLoading');
        }, 1200);
    }
    window.handleSignup = function(event) {
        event.preventDefault();
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const phone = document.getElementById('phoneNumber').value;
        hideMessage('signupError');
        hideMessage('signupSuccess');
        if (password !== confirmPassword) {
            showMessage('signupError', 'Passwords do not match.');
            return;
        }
        if (users.find(u => u.email === email)) {
            showMessage('signupError', 'Email already registered. Please use a different email.');
            return;
        }
        showLoading('signupLoading');
        setTimeout(() => {
            const newUser = { id: users.length + 1, name, email, password, phone };
            users.push(newUser);
            saveUsersToStorage();
            currentUser = newUser;
            saveCurrentUserToStorage();
            showMessage('signupSuccess', 'Account created successfully! Redirecting...');
            setTimeout(() => {
                window.closeLoginModal();
            }, 1200);
            hideLoading('signupLoading');
        }, 1500);
    }
    window.handleAdminLogin = function(event) {
        event.preventDefault();
        const email = document.getElementById('adminEmail').value;
        const password = document.getElementById('adminPassword').value;
        const code = document.getElementById('adminCode').value;
        showLoading('adminLoading');
        hideMessage('adminError');
        hideMessage('adminSuccess');
        setTimeout(() => {
            if (email === adminCredentials.email && password === adminCredentials.password && code === adminCredentials.code) {
                currentUser = { name: 'Admin', email: email, role: 'admin' };
                saveCurrentUserToStorage(); // Ensure admin session is saved
                showMessage('adminSuccess', 'Admin login successful! Redirecting...');
                setTimeout(() => {
                    window.closeLoginModal();
                }, 1200);
            } else {
                showMessage('adminError', 'Invalid admin credentials. Access denied.');
            }
            hideLoading('adminLoading');
        }, 1200);
    }
    window.continueAsGuest = function() {
        isGuest = true;
        currentUser = { name: 'Guest', email: null, role: 'guest' };
        saveCurrentUserToStorage(); // Ensure guest session is saved
        window.closeLoginModal();
        document.getElementById('userDisplayName').textContent = 'Guest';
    }
    window.socialLogin = function(provider) {
        alert(`${provider} login would be implemented here with OAuth integration.`);
    }
    window.showForgotPassword = function() {
        const email = prompt('Please enter your email address:');
        if (email) {
            alert(`Password reset link has been sent to ${email}`);
        }
    }
    function showLoading(id) {
        document.getElementById(id).style.display = 'block';
    }
    function hideLoading(id) {
        document.getElementById(id).style.display = 'none';
    }
    function showMessage(id, message) {
        const element = document.getElementById(id);
        element.textContent = message;
        element.style.display = 'block';
    }
    function hideMessage(id) {
        document.getElementById(id).style.display = 'none';
    }
    </script>
    <!-- Cart Modal Overlay for Shopping Cart -->
    <div id="cartModalOverlay" style="display:none;">
      <div id="cartModalContent">
        <button id="closeCartModal" style="float:right;font-size:1.5rem;background:none;border:none;cursor:pointer;">&times;</button>
        <h2>Your Cart</h2>
        <div id="cartItems"></div>
        <div id="cartTotal"></div>
      </div>
    </div>
    <script>
    // Cart modal open/close logic and API integration
    document.getElementById('cartIcon').addEventListener('click', function() {
      document.getElementById('cartModalOverlay').classList.add('active');
      fetchCartAndRender();
    });
    document.getElementById('closeCartModal').addEventListener('click', function() {
      document.getElementById('cartModalOverlay').classList.remove('active');
    });
    document.getElementById('cartModalOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        document.getElementById('cartModalOverlay').classList.remove('active');
      }
    });
    async function fetchCartAndRender() {
      const cartItemsDiv = document.getElementById('cartItems');
      const cartTotalDiv = document.getElementById('cartTotal');
      if (!cart.length) {
        cartItemsDiv.innerHTML = `
          <div style="text-align:center; padding: 40px 0; color: #888;">
            <img id="cartGifImg" src="cart.gif" alt="Empty Cart" style="width:220px;max-width:100%;margin-bottom:18px;"/>
            <div style="font-size: 20px; font-weight: 500;">Your cart is empty</div>
            <div style="font-size: 14px; margin-top: 8px;">Start shopping and add items to your cart!</div>
          </div>
        `;
        cartTotalDiv.innerHTML = '';
        return;
      }
      cartItemsDiv.innerHTML = '<div style="text-align:center;">Loading...</div>';
      cartTotalDiv.innerHTML = '';
      let total = 0;
      // Use local allProducts first, fallback to API if not found
      let productDetails = await Promise.all(cart.map(async item => {
        let product = allProducts.find(p => p.id === item.id);
        if (product) return product;
        try {
          const res = await fetch(`https://dummyjson.com/products/${item.id}`);
          return await res.json();
        } catch {
          return null;
        }
      }));
      cartItemsDiv.innerHTML = cart.map((item, idx) => {
        const product = productDetails[idx];
        if (!product) return '';
        const itemTotal = product.price * item.quantity;
        total += itemTotal;
        return `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
            <img src="${product.thumbnail}" alt="${product.title}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">
            <div style="flex:1;">
              <div style="font-weight:600;">${product.title}</div>
              <div style="font-size:14px;color:#666;">$${product.price}</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <button class="cart-qty-btn" onclick="changeCartQty(${item.id}, -1)">-</button>
              <span style="min-width:24px;display:inline-block;text-align:center;">${item.quantity}</span>
              <button class="cart-qty-btn" onclick="changeCartQty(${item.id}, 1)">+</button>
            </div>
            <div style="font-weight:600;min-width:70px;text-align:right;">$${(itemTotal).toFixed(2)}</div>
          </div>
        `;
      }).join('');
      cartTotalDiv.innerHTML = `<hr><div style="text-align:right;font-size:18px;font-weight:700;">Total: $${total.toFixed(2)}</div>
        <div style='display:flex;gap:12px;justify-content:flex-end;margin-top:18px;'>
          <button id='continueShoppingBtn' style='padding:10px 18px;border-radius:8px;border:none;background:#eee;color:#333;font-weight:500;cursor:pointer;'>Continue Shopping</button>
          <button id='checkoutBtn' style='padding:10px 18px;border-radius:8px;border:none;background:#4ecdc4;color:#fff;font-weight:600;cursor:pointer;'>Checkout</button>
        </div>`;
      // Attach event listeners for new buttons
      setTimeout(() => {
        document.getElementById('continueShoppingBtn').onclick = function() {
          document.getElementById('cartModalOverlay').classList.remove('active');
        };
        document.getElementById('checkoutBtn').onclick = function() {
          // Calculate total
          let total = 0;
          let productDetails = [];
          Promise.all(cart.map(async item => {
            let product = allProducts.find(p => p.id === item.id);
            if (product) return product;
            try {
              const res = await fetch(`https://dummyjson.com/products/${item.id}`);
              return await res.json();
            } catch {
              return null;
            }
          })).then(details => {
            productDetails = details;
            cart.forEach((item, idx) => {
              if (productDetails[idx]) {
                total += productDetails[idx].price * item.quantity;
              }
            });
            showPaymentModal(total);
          });
        };
      }, 0);
    }
    window.changeCartQty = async function(productId, delta) {
      const idx = cart.findIndex(item => item.id === productId);
      if (idx !== -1) {
        // Only check stock if increasing
        if (delta > 0) {
          let product = null;
          try {
            product = allProducts.find(p => p.id === productId);
            if (!product) {
              const res = await fetch(`https://dummyjson.com/products/${productId}`);
              product = await res.json();
            }
          } catch { product = null; }
          if (product && cart[idx].quantity >= product.stock) {
            showAlertModal('You cannot add more than the available stock for this product.');
            return;
          }
        }
        cart[idx].quantity += delta;
        if (cart[idx].quantity <= 0) {
          cart.splice(idx, 1);
          // Animate cart icon on removal
          animateCartIconRemove();
        }
        updateCartCount();
        saveCartToStorage();
        fetchCartAndRender();
      }
    }
    // For removal from cart, you can add a fade-out effect on the cart icon
    function animateCartIconRemove() {
      const icon = document.querySelector('#cartIcon');
      if (icon) {
        icon.style.transition = 'opacity 0.5s';
        icon.style.opacity = '0.2';
        setTimeout(() => { icon.style.opacity = ''; icon.style.transition = ''; }, 500);
      }
    }
    </script>
    <script>
    // --- CART PERSISTENCE LOGIC ---
    function saveCartToStorage() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }
    function loadCartFromStorage() {
      const stored = localStorage.getItem('cart');
      if (stored) {
        try {
          cart = JSON.parse(stored);
          if (!Array.isArray(cart)) cart = [];
        } catch {
          cart = [];
        }
      }
    }
    // Load cart on page load
    loadCartFromStorage();
    // Update cart count after loading
    updateCartCount();
    </script>
    <script>
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem('hasVisited');
      // Clear user info
      document.getElementById('userDisplayName').textContent = 'Guest';
      // Clear cart
      cart = [];
      localStorage.removeItem('cart');
      updateCartCount();
      // Clear current user
      currentUser = null;
      localStorage.removeItem('currentUser');
      // Close cart modal if open
      document.getElementById('cartModalOverlay').classList.remove('active');
      showLoginModalIfNeeded();
    };
    </script>
    <script>
    // --- USER ACCOUNTS PERSISTENCE LOGIC ---
    function saveUsersToStorage() {
      localStorage.setItem('users', JSON.stringify(users));
    }
    function loadUsersFromStorage() {
      const stored = localStorage.getItem('users');
      if (stored) {
        try {
          users = JSON.parse(stored);
          if (!Array.isArray(users)) users = [];
        } catch {
          users = [];
        }
      }
    }
    function saveCurrentUserToStorage() {
      if (currentUser) {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
      } else {
        localStorage.removeItem('currentUser');
      }
    }
    function loadCurrentUserFromStorage() {
      const stored = localStorage.getItem('currentUser');
      if (stored) {
        try {
          currentUser = JSON.parse(stored);
        } catch {
          currentUser = null;
        }
      }
    }
    // --- ON PAGE LOAD: LOAD USERS, CURRENT USER, UPDATE UI ---
    loadUsersFromStorage();
    loadCurrentUserFromStorage();
    // Update user display and admin panel button on page load
    function updateUserDisplayAndAdminPanel() {
      if (currentUser && currentUser.name) {
        document.getElementById('userDisplayName').textContent = currentUser.name;
      } else {
        document.getElementById('userDisplayName').textContent = 'Guest';
      }
      if (typeof showAdminPanelBtnIfAdmin === 'function') {
        showAdminPanelBtnIfAdmin();
      }
    }
    updateUserDisplayAndAdminPanel();
    // Also update on login/logout
    window.closeLoginModal = (function(orig){
      return function() {
        orig.apply(this, arguments);
        updateWishlistIcon && updateWishlistIcon();
        if (typeof showAdminPanelBtnIfAdmin === 'function') {
          showAdminPanelBtnIfAdmin();
        }
        if (typeof updateUserDisplayAndAdminPanel === 'function') {
          updateUserDisplayAndAdminPanel();
        }
      }
    })(window.closeLoginModal);
    </script>
    <!-- Out of Stock/Alert Modal -->
    <div id="alertModalOverlay" style="display:none;">
      <div id="alertModalContent">
        <div id="alertModalMessage" style="font-size:20px;text-align:center;margin-bottom:24px;"></div>
        <button id="closeAlertModal" style="display:block;margin:0 auto;padding:10px 24px;border-radius:8px;border:none;background:#4ecdc4;color:#fff;font-weight:600;cursor:pointer;">OK</button>
      </div>
    </div>
    <script>
    // --- ALERT MODAL LOGIC ---
    function showAlertModal(message) {
      document.getElementById('alertModalMessage').textContent = message;
      document.getElementById('alertModalOverlay').classList.add('active');
      document.body.classList.add('modal-blur');
    }
    document.getElementById('closeAlertModal').onclick = function() {
      document.getElementById('alertModalOverlay').classList.remove('active');
      document.body.classList.remove('modal-blur');
    };
    </script>
    <!-- Product Details Modal Overlay for Viewing Product Info -->
    <div id="productModalOverlay" style="display:none;">
      <div id="productModalContent"></div>
    </div>
    <script>
    // --- PRODUCT DETAILS MODAL LOGIC ---
    function isClothingCategory(product) {
      const clothingCategories = [
        'mens-shirts', 'womens-dresses', 'womens-shoes', 'mens-shoes', 'tops', 'womens-bags', 'womens-jewellery', 'sunglasses'
      ];
      return clothingCategories.includes(product.category);
    }
    function getReviews(productId) {
      const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');
      return reviews[productId] || [];
    }
    function saveReview(productId, review) {
      const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');
      if (!reviews[productId]) reviews[productId] = [];
      reviews[productId].push(review);
      localStorage.setItem('reviews', JSON.stringify(reviews));
    }
    function renderReviews(productId) {
      const reviews = getReviews(productId);
      if (!reviews.length) return `<div style='color:#888;text-align:center;'>No reviews yet.</div>`;
      return reviews.map(r => `
        <div style='border-bottom:1px solid #eee;padding:10px 0;'>
          <div style='font-weight:600;'>${r.user}</div>
          <div style='color:#f5b301;'>${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</div>
          <div style='font-size:15px;'>${r.comment}</div>
          <div style='font-size:12px;color:#aaa;'>${r.date}</div>
        </div>
      `).join('');
    }
    function showProductModal(productId) {
      document.getElementById('productModalOverlay').classList.add('active');
      document.body.classList.add('modal-blur-product');
      const content = document.getElementById('productModalContent');
      content.innerHTML = '<div style="text-align:center;padding:40px 0;">Loading...</div>';
      // Try to find product in allProducts first (local products)
      let product = allProducts.find(p => String(p.id) === String(productId));
      if (product) {
        renderProductModalContent(product);
        return;
      }
      fetch(`https://dummyjson.com/products/${productId}`)
        .then(res => res.json())
        .then(product => {
          renderProductModalContent(product);
        });
    }
    function renderProductModalContent(product) {
      const content = document.getElementById('productModalContent');
      let sizeSelector = '';
      if (isClothingCategory(product)) {
        sizeSelector = `
          <div style='margin-bottom:12px;'>
            <label for='sizeSelect' style='font-weight:500;'>Size:</label>
            <select id='sizeSelect' style='margin-left:8px;padding:4px 12px;border-radius:6px;'>
              <option value='S'>S</option>
              <option value='M'>M</option>
              <option value='L'>L</option>
              <option value='XL'>XL</option>
            </select>
          </div>
        `;
      }
      // Image gallery logic
      const images = product.images && product.images.length ? product.images : [product.thumbnail];
      let galleryHtml = `
        <div style='display:flex;flex-direction:column;align-items:center;gap:12px;'>
          <img id='mainProductImage' src='${images[0]}' alt='${product.title}' style='width:220px;max-width:100%;border-radius:12px;object-fit:cover;'>
          <div style='display:flex;gap:8px;flex-wrap:wrap;justify-content:center;'>
            ${images.map((img,i) => `<img src='${img}' data-idx='${i}' class='product-thumb' style='width:48px;height:48px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid ${i===0?'#4ecdc4':'#eee'};background:#fff;'>`).join('')}
          </div>
        </div>
      `;
      const reviewsHtml = `
        <div style='margin-top:32px;'>
          <h3 style='margin-bottom:8px;'>Reviews</h3>
          <div id='reviewsList'>${renderReviews(product.id)}</div>
          <div id='reviewFormContainer' style='margin-top:16px;'></div>
        </div>
      `;
      content.innerHTML = `
        <button id='closeProductModal' style='float:right;font-size:1.5rem;background:none;border:none;cursor:pointer;'>&times;</button>
        <div style='display:flex;flex-wrap:wrap;gap:24px;'>
          <div style='display:flex;flex-direction:column;align-items:center;gap:8px;'>
            ${galleryHtml}
          </div>
          <div style='flex:1;min-width:200px;'>
            <h2 style='margin-top:0;'>${product.title}</h2>
            <div style='font-size:22px;color:#4ecdc4;font-weight:700;margin-bottom:8px;'>$${product.price}</div>
            <div style='margin-bottom:8px;'>${'★'.repeat(Math.round(product.rating))}${'☆'.repeat(5-Math.round(product.rating))} (${product.rating})</div>
            <div style='margin-bottom:8px;color:#666;'>${product.stock > 0 ? product.stock + ' in stock' : 'Out of stock'}</div>
            <div style='margin-bottom:16px;'>${product.description && product.description.trim() ? product.description : "<span style='color:#888;'>No description provided for this product.</span>"}</div>
            ${sizeSelector}
            <button onclick='addToCartWithSize(${product.id})' style='padding:12px 28px;border-radius:8px;border:none;background:#4ecdc4;color:#fff;font-weight:600;font-size:16px;cursor:pointer;' ${product.stock === 0 ? 'disabled style="background:#ccc;cursor:not-allowed;"' : ''}>Add to Cart</button>
          </div>
        </div>
        ${reviewsHtml}
      `;
      // Gallery JS
      setTimeout(() => {
        const mainImg = document.getElementById('mainProductImage');
        document.querySelectorAll('.product-thumb').forEach(thumb => {
          thumb.onclick = function() {
            mainImg.src = this.src;
            document.querySelectorAll('.product-thumb').forEach(t => t.style.border = '2px solid #eee');
            this.style.border = '2px solid #4ecdc4';
          };
        });
      }, 0);
      document.getElementById('closeProductModal').onclick = function() {
        document.getElementById('productModalOverlay').classList.remove('active');
        document.body.classList.remove('modal-blur-product');
      };
      // Render review form if logged in
      if (currentUser && currentUser.name && currentUser.email) {
        document.getElementById('reviewFormContainer').innerHTML = `
          <form id='reviewForm' style='margin-top:12px;'>
            <label for='reviewRating'>Your Rating:</label>
            <select id='reviewRating' style='margin:0 8px;'>
              <option value='5'>5</option>
              <option value='4'>4</option>
              <option value='3'>3</option>
              <option value='2'>2</option>
              <option value='1'>1</option>
            </select>
            <input id='reviewComment' type='text' placeholder='Write a comment...' style='width:60%;padding:4px 8px;border-radius:6px;border:1px solid #ccc;margin:0 8px;'>
            <button type='submit' style='padding:4px 16px;border-radius:6px;background:#4ecdc4;color:#fff;border:none;font-weight:600;cursor:pointer;'>Submit</button>
          </form>
        `;
        document.getElementById('reviewForm').onsubmit = function(e) {
          e.preventDefault();
          const rating = parseInt(document.getElementById('reviewRating').value);
          const comment = document.getElementById('reviewComment').value.trim();
          if (!comment) return;
          saveReview(product.id, {
            user: currentUser.name,
            rating,
            comment,
            date: new Date().toLocaleString()
          });
          document.getElementById('reviewsList').innerHTML = renderReviews(product.id);
          document.getElementById('reviewForm').reset();
        };
      } else {
        document.getElementById('reviewFormContainer').innerHTML = `<div style='color:#888;font-size:14px;'>Log in to add a review.</div>`;
      }
    }
    // Add to cart with size support
    window.addToCartWithSize = async function(productId) {
      let size = 'M';
      const sizeSelect = document.getElementById('sizeSelect');
      if (sizeSelect) size = sizeSelect.value;
      // Add size to cart item (optional: you can use it in your cart display if you want)
      let product = allProducts.find(p => p.id === productId);
      if (!product) {
        try {
          const res = await fetch(`https://dummyjson.com/products/${productId}`);
          product = await res.json();
        } catch { product = null; }
      }
      if (!product) return;
      const cartItem = cart.find(item => item.id === productId && item.size === size);
      const inCartQty = cartItem ? cartItem.quantity : 0;
      if (product.stock === 0) {
        showAlertModal('Sorry, this product is out of stock.');
        return;
      }
      if (inCartQty >= product.stock) {
        showAlertModal('You cannot add more than the available stock for this product.');
        return;
      }
      if (cartItem) {
        cartItem.quantity += 1;
      } else {
        cart.push({ id: productId, quantity: 1, size });
      }
      updateCartCount();
      saveCartToStorage();
      showAlertModal('Added to cart!');
    }
    // --- MAKE PRODUCT IMAGE AND TITLE CLICKABLE ---
    function makeProductCardsInteractive() {
      document.querySelectorAll('.product-card').forEach(card => {
        const img = card.querySelector('.product-image');
        const title = card.querySelector('.product-title');
        const id = card.getAttribute('data-product-id');
        if (img) img.style.cursor = 'pointer';
        if (title) title.style.cursor = 'pointer';
        if (img) img.onclick = () => showProductModal(id);
        if (title) title.onclick = () => showProductModal(id);
      });
    }
    </script>
    <!-- Visa Payment Modal Overlay for Checkout -->
    <div id="paymentModalOverlay" style="display:none;">
      <div id="paymentModalContent"></div>
    </div>
    <script>
    // --- PAYMENT MODAL LOGIC ---
    function showPaymentModal(total) {
        closeSidebar(); // Always close sidebar when opening payment modal
        document.getElementById('paymentModalOverlay').classList.add('active');
        document.body.classList.add('modal-blur');
        const content = document.getElementById('paymentModalContent');
        content.innerHTML = `
          <button id='closePaymentModal' style='float:right;font-size:1.5rem;background:none;border:none;cursor:pointer;'>&times;</button>
          <h2 style='margin-bottom:18px;'>Visa Payment</h2>
          <form id='paymentForm'>
            <input type='text' id='cardNumber' maxlength='19' placeholder='Card Number (16 digits)' required pattern='[0-9 ]{16,19}' autocomplete='cc-number'><br>
            <input type='text' id='expiry' maxlength='5' placeholder='MM/YY' required pattern='[0-9]{2}/[0-9]{2}' autocomplete='cc-exp'><br>
            <input type='text' id='cvv' maxlength='4' placeholder='CVV' required pattern='[0-9]{3,4}' autocomplete='cc-csc'><br>
            <div style='font-size:14px;color:#888;margin:8px 0 16px 0;'>Test with:<br>Card: <b>4111 1111 1111 1111</b><br>Expiry: <b>12/30</b><br>CVV: <b>123</b></div>
            <button type='submit'>Pay $${total.toFixed(2)}</button>
            <button type='button' id='backToCartBtn' style='margin-left:12px;background:#eee;color:#333;'>Back to Cart</button>
            <div class='loading' id='paymentLoading' style='display:none;'>Processing payment...</div>
            <div id='paymentResult' style='margin-top:16px;'></div>
          </form>
        `;
        document.getElementById('closePaymentModal').onclick = function() {
          document.getElementById('paymentModalOverlay').classList.remove('active');
          document.body.classList.remove('modal-blur');
        };
        document.getElementById('backToCartBtn').onclick = function() {
          document.getElementById('paymentModalOverlay').classList.remove('active');
          document.body.classList.remove('modal-blur');
          document.getElementById('cartModalOverlay').classList.add('active');
        };
        document.getElementById('paymentForm').onsubmit = function(e) {
          e.preventDefault();
          document.getElementById('paymentLoading').style.display = 'block';
          document.getElementById('paymentResult').textContent = '';
          // Simulate API call
          setTimeout(() => {
            document.getElementById('paymentLoading').style.display = 'none';
            // Only allow standard Visa test card
            const card = document.getElementById('cardNumber').value.replace(/\s+/g, '');
            const expiry = document.getElementById('expiry').value.trim();
            const cvv = document.getElementById('cvv').value.trim();
            if (card === '4111111111111111' && expiry === '12/30' && cvv === '123') {
              document.getElementById('paymentResult').innerHTML = `
                <div style="text-align:center;">
                  <img id="purchasedGifImg" src="purchased.gif" alt="Purchased" style="width:220px;max-width:100%;margin-bottom:18px;"/>
                  <div style='color:green;font-weight:600;'>Payment successful! Thank you for your purchase.</div>
                </div>
              `;
              cart = [];
              saveCartToStorage();
              updateCartCount();
            } else {
              document.getElementById('paymentResult').innerHTML = `<span style='color:red;font-weight:600;'>Payment failed. Please use the standard Visa test card.<br>Card: 4111 1111 1111 1111<br>Expiry: 12/30<br>CVV: 123</span>`;
            }
          }, 1800);
        };
    }
    </script>
    <script>
    // Dark/Light mode switcher logic
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeIcon = document.getElementById('themeIcon');
    function setTheme(dark) {
      if (dark) {
        document.body.classList.add('dark-mode');
        themeIcon.textContent = '☀️';
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        themeIcon.textContent = '🌙';
        localStorage.setItem('theme', 'light');
      }
    }
    themeToggleBtn.onclick = function() {
      setTheme(!document.body.classList.contains('dark-mode'));
    };
    // On load, set theme from localStorage
    if (localStorage.getItem('theme') === 'dark') {
      setTheme(true);
    } else {
      setTheme(false);
    }
    </script>
    <script>
    // --- SEARCH AUTOCOMPLETE/RECOMMENDATIONS ---
    const searchSuggestions = document.getElementById('searchSuggestions');
    let suggestionIndex = -1;
    searchInput.addEventListener('input', function(e) {
      const value = this.value.trim().toLowerCase();
      if (!value) {
        searchSuggestions.style.display = 'none';
        searchSuggestions.innerHTML = '';
        return;
      }
      // Get up to 8 matching product titles
      const matches = allProducts
        .filter(p => p.title.toLowerCase().includes(value))
        .slice(0, 8);
      if (matches.length === 0) {
        searchSuggestions.style.display = 'none';
        searchSuggestions.innerHTML = '';
        return;
      }
      searchSuggestions.innerHTML = matches.map((p, i) =>
        `<div class="search-suggestion" data-title="${p.title.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${p.title}</div>`
      ).join('');
      searchSuggestions.style.display = 'block';
      suggestionIndex = -1;
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
      const items = Array.from(searchSuggestions.querySelectorAll('.search-suggestion'));
      if (!items.length || searchSuggestions.style.display === 'none') return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        suggestionIndex = (suggestionIndex + 1) % items.length;
        items.forEach((el, i) => el.classList.toggle('active', i === suggestionIndex));
        items[suggestionIndex].scrollIntoView({block:'nearest'});
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        suggestionIndex = (suggestionIndex - 1 + items.length) % items.length;
        items.forEach((el, i) => el.classList.toggle('active', i === suggestionIndex));
        items[suggestionIndex].scrollIntoView({block:'nearest'});
      } else if (e.key === 'Enter') {
        if (suggestionIndex >= 0 && suggestionIndex < items.length) {
          e.preventDefault();
          items[suggestionIndex].click();
        }
      } else if (e.key === 'Escape') {
        searchSuggestions.style.display = 'none';
        searchSuggestions.innerHTML = '';
      }
    });

    // Mouse click selection
    searchSuggestions.addEventListener('mousedown', function(e) {
      if (e.target.classList.contains('search-suggestion')) {
        searchInput.value = e.target.getAttribute('data-title');
        searchSuggestions.style.display = 'none';
        searchSuggestions.innerHTML = '';
        applyFilters();
        searchInput.blur();
      }
    });

    // Hide suggestions on blur (with slight delay for click)
    searchInput.addEventListener('blur', function() {
      setTimeout(() => {
        searchSuggestions.style.display = 'none';
        searchSuggestions.innerHTML = '';
      }, 120);
    });
    </script>
    <!-- Wishlist Modal Overlay for Favorites -->
    <div id="wishlistModalOverlay" style="display:none;">
      <div id="wishlistModalContent">
        <button id="closeWishlistModal" style="float:right;font-size:1.5rem;background:none;border:none;cursor:pointer;">&times;</button>
        <h2>Your Wishlist</h2>
        <div id="wishlistItems"></div>
      </div>
    </div>
    <script>
    // --- WISHLIST / FAVORITES FEATURE ---
    function getWishlistKey() {
      return currentUser && currentUser.email ? `wishlist_${currentUser.email}` : 'wishlist_guest';
    }
    function loadWishlist() {
      try {
        return JSON.parse(localStorage.getItem(getWishlistKey()) || '[]');
      } catch { return []; }
    }
    function saveWishlist(wishlist) {
      localStorage.setItem(getWishlistKey(), JSON.stringify(wishlist));
    }
    function isInWishlist(productId) {
      return loadWishlist().includes(productId);
    }
    function toggleWishlist(productId) {
      let wishlist = loadWishlist();
      const isAdding = !wishlist.includes(productId);
      if (isAdding) {
        wishlist.push(productId);
      } else {
        wishlist = wishlist.filter(id => id !== productId);
      }
      saveWishlist(wishlist);
      updateWishlistIcon();
      updateProductHearts();
      // --- FLY TO FAVORITE ANIMATION ---
      if (isAdding) {
        // Find the product card and image
        const card = document.querySelector(`.product-card[data-product-id='${productId}']`);
        if (card) {
          const img = card.querySelector('.product-image');
          animateFlyToIcon(img, '#wishlistBtn');
        }
      } else {
        // Remove: fade out the heart icon briefly
        const heart = document.querySelector(`.product-card[data-product-id='${productId}'] .wishlist-heart`);
        if (heart) {
          heart.style.transition = 'opacity 0.5s';
          heart.style.opacity = '0.2';
          setTimeout(() => { heart.style.opacity = ''; heart.style.transition = ''; }, 500);
        }
      }
      // If the wishlist modal is open, re-render it
      const wishlistModal = document.getElementById('wishlistModalOverlay');
      if (wishlistModal && wishlistModal.classList.contains('active')) {
        renderWishlistModal();
      }
    }
    function updateWishlistIcon() {
      const icon = document.getElementById('wishlistIcon');
      const wishlist = loadWishlist();
      icon.textContent = wishlist.length ? '♥' : '♡';
      icon.style.color = wishlist.length ? '#ff6b6b' : '';
    }
    function updateProductHearts() {
      document.querySelectorAll('.wishlist-heart').forEach(el => {
        const pid = parseInt(el.getAttribute('data-product-id'));
        if (isInWishlist(pid)) {
          el.classList.add('favorited');
          el.textContent = '♥';
        } else {
          el.classList.remove('favorited');
          el.textContent = '♡';
        }
      });
    }
    function renderWishlistModal() {
      const wishlist = loadWishlist();
      const container = document.getElementById('wishlistItems');
      if (!wishlist.length) {
        container.innerHTML = `
          <div style="text-align:center; color:#888; padding:40px 0;">
            <img id="favGifImg" src="fav.gif" alt="Empty Wishlist" style="width:220px;max-width:100%;margin-bottom:18px;"/>
            <div>Your wishlist is empty.</div>
          </div>
        `;
        return;
      }
      // Use local allProducts first, fallback to API if not found
      Promise.all(wishlist.map(async id => {
        let product = allProducts.find(p => p.id === id);
        if (product) return product;
        try {
          const res = await fetch(`https://dummyjson.com/products/${id}`);
          return await res.json();
        } catch {
          return null;
        }
      })).then(products => {
        container.innerHTML = products.map(product => {
          if (!product) return '';
          return `
            <div style='display:flex;align-items:center;gap:16px;margin-bottom:18px;'>
              <img src="${product.thumbnail}" alt="${product.title}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">
              <div style="flex:1;">
                <div style="font-weight:600;">${product.title}</div>
                <div style="font-size:14px;color:#666;">$${product.price}</div>
              </div>
              <button onclick="toggleWishlist(${product.id})" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#ff6b6b;">♥</button>
              <button onclick="addToCart(${product.id})" style="padding:6px 14px;border-radius:8px;border:none;background:#4ecdc4;color:#fff;font-weight:600;cursor:pointer;">Add to Cart</button>
            </div>
          `;
        }).join('');
      });
    }
    document.getElementById('wishlistBtn').onclick = function() {
      document.getElementById('wishlistModalOverlay').classList.add('active');
      renderWishlistModal();
    };
    document.getElementById('closeWishlistModal').onclick = function() {
      document.getElementById('wishlistModalOverlay').classList.remove('active');
    };
    document.getElementById('wishlistModalOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        document.getElementById('wishlistModalOverlay').classList.remove('active');
      }
    });
    // Add hearts to product cards after rendering
    function addWishlistHeartsToCards() {
      document.querySelectorAll('.product-card').forEach(card => {
        let heart = card.querySelector('.wishlist-heart');
        if (!heart) {
          heart = document.createElement('span');
          heart.className = 'wishlist-heart';
          heart.setAttribute('data-product-id', card.getAttribute('data-product-id'));
          card.appendChild(heart);
          heart.onclick = function(e) {
            e.stopPropagation();
            toggleWishlist(parseInt(card.getAttribute('data-product-id')));
          };
        }
      });
      updateProductHearts();
    }
    // Add heart to product modal
    function addWishlistHeartToProductModal(productId) {
      const content = document.getElementById('productModalContent');
      let heart = content.querySelector('.wishlist-heart');
      if (!heart) {
        heart = document.createElement('span');
        heart.className = 'wishlist-heart';
        heart.setAttribute('data-product-id', productId);
        content.appendChild(heart);
        heart.onclick = function(e) {
          e.stopPropagation();
          toggleWishlist(productId);
        };
      }
      updateProductHearts();
    }
    // Update hearts after rendering products
    const origRenderProducts = renderProducts;
    renderProducts = function() {
      origRenderProducts();
      addWishlistHeartsToCards();
    };
    // Update heart in product modal after showing
    const origShowProductModal = window.showProductModal || showProductModal;
    window.showProductModal = function(productId) {
      origShowProductModal(productId);
      setTimeout(() => addWishlistHeartToProductModal(parseInt(productId)), 100);
    };
    // Update wishlist icon on login/logout
    document.addEventListener('DOMContentLoaded', updateWishlistIcon);
    // Also update on user change (after login/logout)
    window.closeLoginModal = (function(orig){
      return function() {
        orig.apply(this, arguments);
        updateWishlistIcon();
      }
    })(window.closeLoginModal);
    </script>
    <!-- Admin Panel Modal Overlay for Product/User Management -->
    <div id="adminPanelModalOverlay" style="display:none;">
      <div id="adminPanelModalContent">
        <button id="closeAdminPanelModal" style="float:right;font-size:1.5rem;background:none;border:none;cursor:pointer;">&times;</button>
        <h2>Admin Panel</h2>
        <div style="margin-bottom:18px;">
          <button id="adminTabProducts" class="admin-tab-btn active">Products</button>
          <button id="adminTabUsers" class="admin-tab-btn">Users</button>
        </div>
        <div id="adminPanelTabs">
          <div id="adminProductsTab"></div>
          <div id="adminUsersTab" style="display:none;"></div>
        </div>
      </div>
    </div>
    <script>
    // --- ADMIN PANEL FEATURE ---
    function isAdmin() {
      return currentUser && currentUser.role === 'admin';
    }
    function showAdminPanelBtnIfAdmin() {
      const btn = document.getElementById('adminPanelBtn');
      btn.style.display = isAdmin() ? '' : 'none';
    }
    document.addEventListener('DOMContentLoaded', showAdminPanelBtnIfAdmin);
    // Also update on user change (after login/logout)
    window.closeLoginModal = (function(orig){
      return function() {
        orig.apply(this, arguments);
        updateWishlistIcon && updateWishlistIcon();
        if (typeof showAdminPanelBtnIfAdmin === 'function') {
          showAdminPanelBtnIfAdmin();
        }
      }
    })(window.closeLoginModal);

    const adminPanelBtn = document.getElementById('adminPanelBtn');
    const adminPanelModalOverlay = document.getElementById('adminPanelModalOverlay');
    const closeAdminPanelModal = document.getElementById('closeAdminPanelModal');
    const adminTabProducts = document.getElementById('adminTabProducts');
    const adminTabUsers = document.getElementById('adminTabUsers');
    const adminProductsTab = document.getElementById('adminProductsTab');
    const adminUsersTab = document.getElementById('adminUsersTab');

    adminPanelBtn.onclick = function() {
      adminPanelModalOverlay.classList.add('active');
      renderAdminProductsTab();
      adminTabProducts.classList.add('active');
      adminTabUsers.classList.remove('active');
      adminProductsTab.style.display = '';
      adminUsersTab.style.display = 'none';
      // Save state
      localStorage.setItem('adminPanelOpen', 'true');
    };
    closeAdminPanelModal.onclick = function() {
      adminPanelModalOverlay.classList.remove('active');
      // Remove state
      localStorage.removeItem('adminPanelOpen');
    };
    adminPanelModalOverlay.addEventListener('click', function(e) {
      if (e.target === this) {
        adminPanelModalOverlay.classList.remove('active');
        localStorage.removeItem('adminPanelOpen');
      }
    });
    adminTabProducts.onclick = function() {
      adminTabProducts.classList.add('active');
      adminTabUsers.classList.remove('active');
      adminProductsTab.style.display = '';
      adminUsersTab.style.display = 'none';
      renderAdminProductsTab();
    };
    adminTabUsers.onclick = function() {
      adminTabUsers.classList.add('active');
      adminTabProducts.classList.remove('active');
      adminProductsTab.style.display = 'none';
      adminUsersTab.style.display = '';
      renderAdminUsersTab();
    };

    function renderAdminProductsTab() {
      let products = Array.isArray(allProducts) ? allProducts : [];
      adminProductsTab.innerHTML = `
        <form id='addProductForm' style='margin-bottom:18px;display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;background:#f8f8f8;padding:12px 16px;border-radius:10px;'>
          <input required name='title' placeholder='Title' style='flex:1;min-width:120px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <input required name='price' type='number' min='0' placeholder='Price' style='width:90px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <input required name='stock' type='number' min='0' placeholder='Stock' style='width:80px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <input required name='rating' type='number' min='0' max='5' step='0.1' placeholder='Rating' style='width:80px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <input required name='category' placeholder='Category' style='width:120px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <input required name='mainImage' placeholder='Main Image URL' style='flex:2;min-width:180px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <input name='images' placeholder='Other Image URLs (comma separated)' style='flex:2;min-width:180px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <input name='description' placeholder='Description (optional)' style='flex:2;min-width:180px;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:15px;'>
          <button type='submit' class='admin-action-btn save' style='margin-left:8px;'>Add Product</button>
        </form>
      `;
      adminProductsTab.innerHTML += `<table class='admin-table'>
        <tr><th>ID</th><th>Title</th><th>Price</th><th>Stock</th><th>Actions</th></tr>
        ${products.map(p => `
          <tr data-id='${p.id}'>
            <td>${p.id}</td>
            <td><input class='admin-edit-input' value="${p.title.replace(/"/g,'&quot;')}" data-field='title'></td>
            <td><input class='admin-edit-input' value="${p.price}" data-field='price' type='number' min='0'></td>
            <td><input class='admin-edit-input' value="${p.stock}" data-field='stock' type='number' min='0'></td>
            <td>
              <button class='admin-action-btn save'>Save</button>
              <button class='admin-action-btn' onclick='deleteAdminProduct(${p.id})'>Delete</button>
            </td>
          </tr>
        `).join('')}
      </table>`;
      // Save buttons
      adminProductsTab.querySelectorAll('.admin-action-btn.save').forEach((btn, idx) => {
        btn.onclick = function() {
          const row = btn.closest('tr');
          const id = parseInt(row.getAttribute('data-id'));
          const title = row.querySelector("[data-field='title']").value.trim();
          const price = parseFloat(row.querySelector("[data-field='price']").value);
          const stock = parseInt(row.querySelector("[data-field='stock']").value);
          let prod = allProducts.find(p => p.id === id);
          if (prod) {
            prod.title = title;
            prod.price = price;
            prod.stock = stock;
            localStorage.setItem('adminProducts', JSON.stringify(allProducts));
            renderProducts();
            renderAdminProductsTab();
          }
        };
      });
      // Add Product Form Logic
      const addProductForm = document.getElementById('addProductForm');
      if (addProductForm) {
        addProductForm.onsubmit = function(e) {
          e.preventDefault();
          const fd = new FormData(addProductForm);
          const title = fd.get('title').trim();
          const price = parseFloat(fd.get('price'));
          const stock = parseInt(fd.get('stock'));
          const rating = parseFloat(fd.get('rating'));
          const category = fd.get('category').trim();
          const mainImage = fd.get('mainImage').trim();
          let images = fd.get('images').trim();
          let imagesArr = images ? images.split(',').map(s=>s.trim()).filter(Boolean) : [];
          // Ensure mainImage is first in images array
          if (mainImage) imagesArr = [mainImage, ...imagesArr.filter(img=>img!==mainImage)];
          const newId = products.length ? Math.max(...products.map(p=>p.id))+1 : 1;
          const description = fd.get('description') ? fd.get('description').trim() : '';
          const newProduct = {
            id: newId,
            title,
            price,
            stock,
            rating,
            category,
            images: imagesArr,
            thumbnail: mainImage,
            description,
            brand: '',
            discountPercentage: 0
          };
          allProducts.push(newProduct);
          localStorage.setItem('adminProducts', JSON.stringify(allProducts));
          renderProducts();
          renderAdminProductsTab();
        };
      }
    }
    window.deleteAdminProduct = function(id) {
      if (!confirm('Delete this product?')) return;
      allProducts = allProducts.filter(p => p.id !== id);
      localStorage.setItem('adminProducts', JSON.stringify(allProducts));
      renderProducts();
      renderAdminProductsTab();
    };

    function renderAdminUsersTab() {
      let users = Array.isArray(window.users) ? window.users : [];
      adminUsersTab.innerHTML = `<table class='admin-table'>
        <tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Role</th></tr>
        ${users.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.phone || ''}</td>
            <td>${u.role || 'user'}</td>
          </tr>
        `).join('')}
      </table>`;
    }

    // On load, if adminProducts in localStorage, use it (already handled in loadProducts)
    if (localStorage.getItem('adminProducts')) {
      try {
        allProducts = JSON.parse(localStorage.getItem('adminProducts'));
      } catch {}
    }
    // On page load, auto-open admin panel if admin and flag is set
    document.addEventListener('DOMContentLoaded', function() {
      // ... your other DOMContentLoaded logic ...
      if (
        currentUser &&
        currentUser.role === 'admin' &&
        localStorage.getItem('adminPanelOpen') === 'true'
      ) {
        adminPanelModalOverlay.classList.add('active');
        renderAdminProductsTab();
        adminTabProducts.classList.add('active');
        adminTabUsers.classList.remove('active');
        adminProductsTab.style.display = '';
        adminUsersTab.style.display = 'none';
      }
    });
    </script>
    <script>
    // Animate the blobs using sine/cosine for a soft floating effect
    function animateBlobs() {
      const blob1 = document.getElementById('blob1');
      const blob2 = document.getElementById('blob2');
      let t = 0;
      function animate() {
        t += 0.02;
        if (blob1) {
          blob1.setAttribute('cx', 150 + Math.sin(t) * 20);
          blob1.setAttribute('ry', 60 + Math.cos(t) * 10);
        }
        if (blob2) {
          blob2.setAttribute('cx', 400 + Math.cos(t/2) * 30);
          blob2.setAttribute('ry', 50 + Math.sin(t/2) * 8);
        }
        requestAnimationFrame(animate);
      }
      animate();
    }
    document.addEventListener('DOMContentLoaded', animateBlobs);
    </script>
    <script>
    // --- RANDOM BUBBLE ANIMATION FOR FLOATING ICONS ---
    document.addEventListener('DOMContentLoaded', function() {
      const icons = document.querySelectorAll('.hero-floating-icons [data-float]');
      icons.forEach((icon, i) => {
        // Get initial left/top as percentages
        const leftPercent = parseFloat(icon.style.left) || 0;
        const topPercent = parseFloat(icon.style.top) || 0;
        // Each icon gets a unique random path
        const amplitudeX = 2 + Math.random() * 3; // percent
        const amplitudeY = 2 + Math.random() * 3; // percent
        const speed = 1.5 + Math.random() * 1.5; // seconds
        const phase = Math.random() * Math.PI * 2;
        const rotateSpeed = 0.5 + Math.random() * 1.5;
        const flip = Math.random() > 0.5 ? -1 : 1;
        function animateBubble() {
          const t = performance.now() / 1000;
          // Animate around the initial position
          const x = leftPercent + Math.sin(t / speed + phase) * amplitudeX;
          const y = topPercent + Math.cos(t / speed + phase) * amplitudeY;
          icon.style.left = `${x}%`;
          icon.style.top = `${y}%`;
          // Rotate and flip
          const rot = Math.sin(t * rotateSpeed + phase) * 20; // -20deg to 20deg
          icon.style.transform = `rotate(${rot}deg) scaleX(${flip})`;
          requestAnimationFrame(animateBubble);
        }
        animateBubble();
      });
    });
    </script>
    <script>
    // Cart modal: replay GIF each time opened
    const cartIconBtn = document.getElementById('cartIcon');
    cartIconBtn.addEventListener('click', function() {
      setTimeout(() => {
        const container = document.getElementById('cartItems');
        if (container) {
          const oldGif = document.getElementById('cartGifImg');
          if (oldGif) {
            const newGif = oldGif.cloneNode();
            newGif.src = 'cart.gif?t=' + Date.now(); // cache-busting
            oldGif.parentNode.replaceChild(newGif, oldGif);
          }
        }
      }, 50);
    });
    // Wishlist modal: replay GIF each time opened
    const wishlistBtn = document.getElementById('wishlistBtn');
    wishlistBtn.addEventListener('click', function() {
      setTimeout(() => {
        const container = document.getElementById('wishlistItems');
        if (container) {
          const oldGif = document.getElementById('favGifImg');
          if (oldGif) {
            const newGif = oldGif.cloneNode();
            newGif.src = 'fav.gif?t=' + Date.now(); // cache-busting
            oldGif.parentNode.replaceChild(newGif, oldGif);
          }
        }
      }, 50);
    });
    </script>
</body>
</html>